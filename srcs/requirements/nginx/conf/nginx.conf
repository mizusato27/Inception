events {
    worker_connections 1024;
}

http {
    # mime.types に定義がない拡張子（または拡張子なし）の場合のデフォルト設定。
    include /etc/nginx/mime.types;
    # 'application/octet-stream' は「任意のバイナリ」を意味し、ブラウザに対して
    # ファイルを解析せずに保存（ダウンロード）させるよう促す。
    default_type application/octet-stream;

    server {
        # ポート443 (SSL) でのリッスン
        listen 443 ssl;
        listen [::]:443 ssl;

        # サーバー名（Dockerfileで指定したCNと一致させる）
        server_name mizusato.42.fr;

        # SSL証明書のパス（Dockerfileでの生成場所と一致させる）
        ssl_certificate /etc/nginx/ssl/inception.crt;
        ssl_certificate_key /etc/nginx/ssl/inception.key;

        # TLSv1.2 または TLSv1.3 のみ許可
        ssl_protocols TLSv1.2 TLSv1.3;

        # ドキュメントルート（WordPressのファイルが置かれる場所）
        root /var/www/html;
        index index.php index.html index.htm;

        # ---------------------------------------------------------------------
        # 静的ファイルおよびルートディレクトリへのリクエスト処理
        # ---------------------------------------------------------------------
        location / {
            # 1. $uri: 指定されたパスに一致するファイルがあるか確認。
            # 2. $uri/: パスに一致するディレクトリがあるか確認（あれば index 指示に従う）。
            # 3. =404: いずれも存在しない場合は、即座に 404 Not Found エラーを返す。
            try_files $uri $uri/ =404;
        }

        # ---------------------------------------------------------------------
        # PHPファイルの処理（FastCGIプロキシ設定）
        # ---------------------------------------------------------------------
        # 正規表現 (~ \.php$) により、リクエストURIの末尾が '.php' である場合に合致。
        location ~ \.php$ {
            # FastCGIプロトコルで使用される標準的なパラメータ群（QUERY_STRING等）を読み込む。
            include fastcgi_params;

            # 処理の転送先を指定。
            # 'wordpress' は Dockerネットワーク内のコンテナ名、'9000' は php-fpm が待機するポート。
            fastcgi_pass wordpress:9000;

            # ディレクトリ指定でアクセスされた場合に補完するPHPファイル名。
            fastcgi_index index.php;

            # 転送先の php-fpm に対して、実行すべきPHPファイルの絶対パスを伝えるための変数設定。
            # $document_root: rootディレクティブで指定したパス (/var/www/html)
            # $fastcgi_script_name: リクエストされたURI (/index.php 等)
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        }
    }
}
